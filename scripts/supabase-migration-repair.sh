#!/usr/bin/env bash
# Repair remote migration history to match local supabase/migrations.
# Run from project root: bash scripts/supabase-migration-repair.sh
# Requires: supabase link (or --db-url) and linked project.
# Uses retries on connection/timeout errors so you can re-run until it finishes.
set -e
cd "$(dirname "$0")/.."

MAX_RETRIES=3
RETRY_DELAY=10

run_repair() {
  local status="$1"
  local version="$2"
  local attempt=1
  while true; do
    if supabase migration repair --status "$status" "$version"; then
      return 0
    fi
    if [[ $attempt -ge $MAX_RETRIES ]]; then
      echo "Failed at $status $version after $MAX_RETRIES attempts."
      return 1
    fi
    echo "Retry $((attempt + 1))/$MAX_RETRIES in ${RETRY_DELAY}s..."
    sleep "$RETRY_DELAY"
    ((attempt++)) || true
  done
}

REVERTED=(
  20260120000000 20260120000001 20260120070000 20260120080000 20260120082000 20260120085000 20260120090000
  20260120110000 20260120114123 20260120122550 20260120150000 20260120160000 20260121170000 20260125122422
  20260125131655 20260125131715 20260125200000 20260128000000 20260128100000 20260128110000 20260128120000
  20260128130000 20260128140000 20260128150000 20260128160000 20260128170000 20260128200000 20260128210000
  20260128220000 20260128230000 20260128235000 20260128240000 20260128250000 20260128260000 20260128260001
  20260128260002 20260128260003 20260128270000 20260129000000 20260129100000 20260129200000 20260129210000
  20260129300000 20260129400000 20260129500000 20260129600000 20260129700000 20260130000000 20260130120000
  20260130130000 20260130140000 20260130150000 20260130160000 20260130170000 20260130180000 20260130200000
  20260130210000 20260130211000 20260130220000 20260130230000 20260130240000 20260130250000 20260130260000
  20260130261000 20260130270000 20260130280000 20260130290000 20260130300000 20260130310000 20260130320000
  20260130330000 20260130340000 20260131140000 20260131140100 20260131150000 20260131160000 20260131170000
  20260131180000 20260131190000 20260131200000 20260131210000 20260201100000 20260201120000 20260201130000
  20260201140000 20260201150000 20260201160000 20260201170000 20260201180000 20260201190000 20260201220000
  20260202100000 20260202105000 20260202110000 20260202120000 20260202130000 20260202140000 20260202150000
  20260202160000 20260202170000 20260202180000 20260202190000 20260202200000 20260202200100 20260202210000
  20260202220000 20260202230000 20260202240000 20260202240100 20260202250000 20260202260000 20260202260001
  20260202270000 20260202280000 20260203100000 20260203110000 20260203120000 20260203130000 20260203140000
  20260203150000 20260203160000 20260203230000 20260203235000 20260203235500 20260203240000 20260203250000
  20260203260000 20260203270000 20260203280000 20260204100000 20260204110000 20260204120000 20260204120500
  20260204130000 20260204140000 20260204150000 20260204160000 20260204170000 20260204180000 20260204190000
  20260204200000 20260204210000 20260204220500 20260204230000 20260204240000 20260204260000 20260204270000
  20260204280000 20260204290000 20260204290500 20260204300000 20260204310000 20260204320000 20260204330000
  20260204350000 20260204360000 20260204370000 20260204400000 20260204500000 20260204600000 20260204700000
  20260204710000 20260204720000 20260204730000 20260204740000 20260205000000 20260205000001 20260205000002
  20260205050000 20260205100000 20260205120000 20260205130000 20260205140000 20260205150000 20260205160000
  20260205170000 20260205180000 20260205190000 20260205200000 20260205210000 20260205220000 20260205230000
  20260205240000 20260205260000 20260205270000 20260205300000 20260205310000 20260205320000 20260205320001
  20260205330000 20260205340000 20260205350000 20260205360000 20260205370000 20260206185101 20260206185304
  20260206195447 20260207200000 20260207210000 20260207220000 20260207221822 20260207225999 20260207230000
  20260207230001 20260207230002 20260207230003 20260207230004 20260208100000 20260208150000 20260209000000
  20260209000001 20260213000000 20260213010000 20260213020000 20260213030000 20260213040000 20260213050000
  20260217120000 20260217130000 20260217230000 20260218100000 20260218110000 20260218200000 20260218210000
  20260219100000 20260219200000 20260219210000 20260219220000 20260219230000 20260219231000 20260219232000
  20260219240000 20260219250000 20260219260000 20260219270000 20260219280000 20260219290000 20260219300000
  20260219310000 20260219320000 20260219330000 20260219340000 20260219350000 20260219360000 20260219370000
  20260219380000 20260219390000 20260220100000 20260220110000 20260220120000 20260220130000 20260220140000
  20260220150000 20260220160000 20260220170000 20260220180000 20260221100000 20260221110000 20260221180000
  20260221190000 20260221200000 20260221210000 20260221220000 20260221230000 20260221230100 20260222000000
  20260222000001 20260222100000 20260222110000 20260222120000 20260222130000 20260222140000 20260222150000
  20260222160000 20260222170000 20260222170100 20260222170200 20260222170400 20260222170500 20260222170600
  20260222200000 20260222210000 20260223100000 20260223100100 20260223100200 20260223100300 20260223100400
  20260223120000 20260223150000 20260223160000 20260223170000 20260223200000 20260223210000 20260223220000
  20260224000000 20260224100000 20260224110000 20260224120000 20260224130000 20260224150000 20260224160000
  20260224170000 20260224180000 20260224190000 20260224191000 20260224192000 20260225000000 20260226000000
  20260226100000 20260226110000 20260226113000 20260226120000 20260227100000 20260228000000 20260228100000
  20260229120000 20260229130000 20260229140000 20260229150000 20260229160000 20260229200000 20260229210000
  20260229220000 20260229230000 20260229230100 20260229240000 20260301100000 20260316120000 20260319100000
  20260323100000 20260323110000 20260323120000 20260324100000 20260325100000 20260326100000 20260327100000
  20260328100000 20260328110000 20260328120000 20260328130000 20260328140000 20260328150000 20260328160000
  20260328170000 20260329100000 20260330100000
)

APPLIED=(
  20260220000001 20260220000002 20260220000003 20260220000004 20260221000001 20260224000001 20260225000002
  20260226000001 20260227000001 20260228000001 20260228000002 20260228000003 20260228000004 20260228000005
)

echo "Repairing remote migration history (revert ${#REVERTED[@]} versions, then mark ${#APPLIED[@]} as applied)..."
echo "Step 1/2: Marking remote-only migrations as reverted..."
for v in "${REVERTED[@]}"; do
  run_repair reverted "$v" || exit 1
done
echo "Step 2/2: Marking local migrations as applied on remote..."
for v in "${APPLIED[@]}"; do
  run_repair applied "$v" || exit 1
done
echo "Done. Run: supabase db pull   (or  supabase db push  to verify)."
